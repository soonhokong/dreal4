# Import user-defined rules
try-import %workspace%/user.bazelrc

# C++17 and default build settings
build --cxxopt=-std=c++17 --host_cxxopt=-std=c++17
build -c opt --force_pic --strip=never --strict_system_includes --copt=-Werror

# Test settings
test --test_output=errors

# Enable Bzlmod (modern module system)
common --enable_bzlmod

# Python: disable auto __init__.py to prevent source truncation
build --incompatible_default_to_explicit_init_py

# Cpplint shortcut
test:cpplint --build_tests_only --test_tag_filters=cpplint

### Sanitizer configs ###
# Common sanitizer flags
build:sanitizer_common --copt=-g --copt=-fno-omit-frame-pointer --copt=-Wno-macro-redefined --copt=-D_FORTIFY_SOURCE=0

# ASan
build:asan --config=sanitizer_common
build:asan --copt=-fno-common --copt=-fsanitize=address --copt=-O0 --copt=-fno-optimize-sibling-calls --copt=-DCDS_ADDRESS_SANITIZER_ENABLED
build:asan --linkopt=-fsanitize=address --linkopt=-fuse-ld=ld --start_end_lib=no
build:asan --test_env=ASAN_OPTIONS --test_env=LSAN_OPTIONS --test_tag_filters=-no_asan,-no_lsan --test_timeout=120,600,1800,7200

# LSan
build:lsan --config=sanitizer_common
build:lsan --copt=-fno-common --copt=-fsanitize=leak --copt=-O0
build:lsan --linkopt=-fsanitize=leak
build:lsan --test_env=LSAN_OPTIONS --test_env=LSAN_SYMBOLIZER_PATH --test_tag_filters=-no_asan,-no_lsan --test_timeout=120,600,1800,7200

# TSan
build:tsan --config=sanitizer_common --build_tests_only --noforce_pic
build:tsan --copt=-fsanitize=thread --copt=-O1 --copt=-DCDS_THREAD_SANITIZER_ENABLED
build:tsan --linkopt=-fsanitize=thread
build:tsan --test_env=TSAN_OPTIONS --test_tag_filters=-no_tsan --test_timeout=180,900,2700,10800

# UBSan
build:ubsan --config=sanitizer_common --build_tests_only
build:ubsan --copt=-fsanitize=undefined --copt=-fno-sanitize=float-divide-by-zero,vptr,function --copt=-O1 --copt=-fsanitize-link-c++-runtime
build:ubsan --linkopt=-fsanitize=undefined --linkopt=-fsanitize-link-c++-runtime --linkopt=-rtlib=compiler-rt
build:ubsan --test_env=UBSAN_OPTIONS --test_tag_filters=-no_ubsan --test_timeout=120,600,1800,7200

# Kcov coverage
build:kcov --copt=-g --copt=-O0
test:kcov --spawn_strategy=local --run_under=//tools:kcov --local_test_jobs=1
test:kcov --test_tag_filters=-cpplint,-pycodestyle,-no_kcov --nocache_test_results --test_timeout=120,600,1800,7200

### Platform-specific configs ###
# macOS: IBEX 2.7.4 uses std::unary_function/binary_function removed in C++17
build:macos --cxxopt=-D_LIBCPP_ENABLE_CXX17_REMOVED_UNARY_BINARY_FUNCTION
